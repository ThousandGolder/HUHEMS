@model HEMS.Models.Question
@{
    int currentIndex = ViewBag.Index;
    int total = ViewBag.Total;
    int durationMinutes = Model.Exam.DurationMinutes > 0 ? Model.Exam.DurationMinutes : 30;

    var answeredIndices = ViewBag.AnsweredIndices as List<int> ?? new List<int>();
    var flaggedIndices = ViewBag.FlaggedIndices as List<int> ?? new List<int>();

    int? selectedChoiceId = ViewBag.SelectedChoiceId;
    bool isCurrentlyFlagged = flaggedIndices.Contains(currentIndex);
}

<div class="container-fluid py-4 exam-secure-zone">
    <div class="row">
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 shadow-sm rounded">
                <h5 class="mb-0 fw-bold text-dark">@Model.Exam.Title</h5>
                <div class="timer-box p-2 px-3 bg-dark text-warning rounded-pill shadow-sm">
                    <i class="bi bi-clock-history me-2"></i><span id="timer" class="fw-bold">--:--:--</span>
                </div>
            </div>

            <div class="card shadow-sm mb-4 border-0">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-2 bg-light border-end p-4 text-center">
                            <div class="sticky-top" style="top: 20px;">
                                <h6 class="text-muted small text-uppercase fw-bold">Question</h6>
                                <h2 class="fw-bold text-primary">@(currentIndex + 1)</h2>
                                <hr />
                                <p class="small mb-2">@(selectedChoiceId.HasValue ? "Answer Saved" : "Not yet answered")</p>
                                <p class="small text-muted mb-3">Points: 1.00</p>

                                <a href="javascript:void(0);" id="flagToggle" class="btn btn-sm @(isCurrentlyFlagged ? "btn-danger" : "btn-outline-secondary") w-100">
                                    <i class="bi @(isCurrentlyFlagged ? "bi-flag-fill" : "bi-flag") me-1"></i>
                                    @(isCurrentlyFlagged ? "Remove flag" : "Flag")
                                </a>
                            </div>
                        </div>

                        <div class="col-md-10 p-4">
                            <div class="question-content-box mb-4">
                                <p class="fs-5 text-dark mb-4">@Model.QuestionText</p>

                                <form asp-controller="Student" asp-action="SubmitAnswer" method="post" id="examForm">
                                    <input type="hidden" name="qId" value="@Model.QuestionId" />
                                    <input type="hidden" name="examId" value="@Model.ExamId" />
                                    <input type="hidden" name="nextIdx" value="@(currentIndex + 1)" />
                                    <input type="hidden" name="flagged" id="flaggedInput" value="@isCurrentlyFlagged.ToString().ToLower()" />

                                    <div class="options mt-2">
                                        @foreach (var choice in Model.Choices)
                                        {
                                            <div class="form-check custom-option mb-3">
                                                <input class="form-check-input option-input" type="radio" name="choiceId"
                                                       value="@choice.ChoiceId" id="choice_@choice.ChoiceId" required
                                                       @(selectedChoiceId == choice.ChoiceId ? "checked" : "")>
                                                <label class="form-check-label ps-2 w-100 cursor-pointer" for="choice_@choice.ChoiceId">
                                                    @choice.ChoiceText
                                                </label>
                                            </div>
                                        }
                                    </div>
                                    <a href="javascript:void(0);" onclick="clearChoice()" class="small text-muted text-decoration-none mt-3 d-inline-block">
                                        <i class="bi bi-eraser"></i> Clear my choice
                                    </a>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-white p-3 d-flex justify-content-between align-items-center">
                    @if (currentIndex > 0)
                    {
                        <a asp-action="TakeExam" asp-route-examId="@Model.ExamId" asp-route-index="@(currentIndex - 1)"
                           class="btn btn-outline-secondary px-4">
                            <i class="bi bi-chevron-left"></i> Previous
                        </a>
                    }
                    else
                    {

                        <div></div>
                    }

                    <button type="button" onclick="submitExamForm()" class="btn btn-primary px-5 fw-bold">
                        @(currentIndex == total - 1 ? "Finish Attempt" : "Next Question")
                        <i class="bi @(currentIndex == total - 1 ? "bi-check2-circle" : "bi-chevron-right") ms-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-white fw-bold py-3 border-bottom">
                    <i class="bi bi-grid-3x3-gap me-2"></i> Quiz Navigation
                </div>
                <div class="card-body">
                    <div class="question-nav-grid mb-4">
                        @for (int i = 0; i < total; i++)
                        {
                            <a asp-action="TakeExam" asp-route-examId="@Model.ExamId" asp-route-index="@i"
                               id="nav-box-@i"
                               class="nav-box @(i == currentIndex ? "current" : "") @(answeredIndices.Contains(i) ? "answered" : "") @(flaggedIndices.Contains(i) ? "flagged" : "")">
                                @(i + 1)
                            </a>
                        }
                    </div>
                    <hr />
                    <button type="button" onclick="submitExamForm(true)" class="btn btn-link text-danger text-decoration-none p-0 small fw-bold">
                        Finish attempt...
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/exam-timer.js" asp-append-version="true"></script>
    <script>
        // Start the persistent timer and security listeners
        $(document).ready(function() {
            initPersistentTimer(@Model.ExamId, @durationMinutes);
            initSecurityFeatures(@Model.ExamId);

            // Standard interactions (Flagging, etc.)
            if(typeof initQuestionInteractions === 'function') {
                 initQuestionInteractions(@currentIndex, @Model.ExamId, @Model.QuestionId);
            }
        });

        function clearChoice() {
            document.querySelectorAll('.option-input').forEach(opt => opt.checked = false);
            document.getElementById('nav-box-' + @currentIndex).classList.remove('answered');
        }

        function submitExamForm(isManualFinish = false) {
            const isLast = @(currentIndex == total - 1 ? "true" : "false");

            if (isLast || isManualFinish) {
                Swal.fire({
                    title: 'Finish Exam?',
                    text: "You are about to submit your exam. You won't be able to change your answers!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#198754',
                    confirmButtonText: 'Yes, Submit Exam'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem(`exam_end_time_` + @Model.ExamId);
                        document.getElementById("examForm").submit();
                    }
                });
            } else {
                document.getElementById("examForm").submit();
            }
        }
    </script>
}