@model IEnumerable<HEMS.Models.Exam>

@{
    ViewData["Title"] = "Student Dashboard";
}

<!-- Inline CSS moved to wwwroot/css/layout.css to centralize theme styles and enable reuse across views -->
<link rel="stylesheet" href="~/css/layout.css" asp-append-version="true" />

@{
    var mustChange = ViewBag.MustChangePassword as bool? ?? false;
}

@if (mustChange)
{
    <div class="alert alert-info d-flex align-items-center shadow-sm border-0">
        <i class="bi bi-info-circle-fill fs-4 me-3"></i>
        <div>
            <strong>Security Tip:</strong> Using your default password?
            <a asp-action="ChangePassword" class="alert-link">Change it now</a> to keep your account safe.
        </div>
    </div>
}


<div class="container-fluid py-4 px-lg-5">
    <div class="page-header p-4 mb-4 shadow-sm d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <div>
            <h2 class="fw-bold mb-1"><i class="bi bi-mortarboard me-2"></i>Student Dashboard</h2>
            <p class="opacity-75 mb-0">Active & Upcoming Assessments</p>
        </div>
        <a asp-action="ViewResult" class="btn btn-outline-light px-4 py-2 fw-semibold">
            <i class="bi bi-trophy me-2"></i>Latest Result
        </a>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show border-0 shadow-sm rounded-3 mb-4" role="alert">
            <i class="bi bi-exclamation-octagon-fill me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!Model.Any())
    {
        <div class="text-center py-5 bg-white rounded-3 shadow-sm border">
            <i class="bi bi-clipboard2-check display-1 text-muted opacity-25"></i>
            <h5 class="mt-3 text-secondary">All caught up! No pending exams found.</h5>
            <p class="text-muted small">Check back later or contact your coordinator.</p>
        </div>
    }
    else
    {
        <div class="card table-card shadow-sm desktop-table border">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr class="text-secondary small text-uppercase fw-bold">
                        <th class="ps-4">Assessment Title</th>
                        <th>Academic Year</th>
                        <th>Duration</th>
                        <th>Availability</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">@item.ExamTitle</div>
                                <span class="text-muted extra-small">Format: Computer Based Test</span>
                            </td>
                            <td><span class="badge bg-light text-dark border"><i class="bi bi-calendar3 me-1"></i>@item.AcademicYear</span></td>
                            <td><i class="bi bi-clock-history me-1"></i>@item.DurationMinutes mins</td>
                            <td>
                                <span class="badge rounded-pill bg-success-subtle text-success px-3">Open for Sitting</span>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-brand btn-sm px-4 rounded-pill"
                                        data-bs-toggle="modal"
                                        data-bs-target="#verifyModal-@item.ExamId">
                                    Start Exam
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mobile-container">
            @foreach (var item in Model)
            {
                <div class="mobile-card shadow-sm">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="title">@item.ExamTitle</div>
                        <span class="badge bg-success-subtle text-success">Active</span>
                    </div>
                    <div class="row g-2 mb-3 text-muted small border-bottom pb-2">
                        <div class="col-6"><i class="bi bi-calendar-event me-1"></i> @item.AcademicYear</div>
                        <div class="col-6 text-end"><i class="bi bi-clock me-1"></i> @item.DurationMinutes mins</div>
                    </div>
                    <button type="button" class="btn btn-brand w-100"
                            data-bs-toggle="modal"
                            data-bs-target="#verifyModal-@item.ExamId">
                        Start Assessment
                    </button>
                </div>
            }
        </div>

        @foreach (var item in Model)
        {
            <div class="modal fade" id="verifyModal-@item.ExamId" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header bg-dark text-white border-0">
                            <h5 class="modal-title fw-bold"><i class="bi bi-lock-fill me-2"></i>Exam Authorization</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form asp-action="VerifyCode" method="post">
                            <div class="modal-body p-4 text-center">
                                <div class="mb-3">
                                    <h6 class="fw-bold text-dark">@item.ExamTitle</h6>
                                    <p class="text-muted small">Please enter the <strong>4-digit Code</strong> provided by your invigilator to unlock this session.</p>
                                </div>

                                <input type="hidden" name="ExamId" value="@item.ExamId" />

                                <div class="form-group mb-4">
                                    <input type="text" name="EnteredCode"
                                           class="form-control exam-id-input rounded-3 shadow-sm"
                                           placeholder="----" required maxlength="10" autocomplete="off">
                                </div>

                                <div class="alert alert-warning p-2 small border-0 mb-0">
                                    <i class="bi bi-info-circle me-1"></i> Once confirmed, your timer will start immediately.
                                </div>
                            </div>
                            <div class="modal-footer border-0 p-3 bg-light">
                                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-brand px-5 fw-bold">Unlock & Begin</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        // Auto-focus the input when modal opens
        $('.modal').on('shown.bs.modal', function () {
            $(this).find('input[name="EnteredCode"]').focus();
        });
    </script>
}