@model IEnumerable<HEMS.Models.Student>

<div class="container py-4">
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white p-4 d-flex justify-content-between align-items-center rounded">
            <div>
                <h3 class="mb-0 fw-bold text-white"><i class="bi bi-people-fill me-2"></i>Student Management</h3>
                <p class="text-white-75 small mb-0">Upload CSV to generate student accounts automatically.</p>
            </div>
            
        </div>
    </div>

@section Scripts {
    <script>
        (function(){
            const fileInput = document.getElementById('studentFileInput');
            const feedback = document.getElementById('bulkUploadFeedback');
            const form = document.getElementById('bulkUploadForm');
            const submitBtn = document.getElementById('bulkUploadSubmit');
            if (!fileInput || !feedback || !form) return;

            form.addEventListener('submit', async function(e){
                // Basic client-side CSV check: read first few lines to extract ID numbers and pre-check duplicates
                const file = fileInput.files[0];
                if (!file) return;
                e.preventDefault();
                submitBtn.disabled = true;
                feedback.style.display = 'none';

                try {
                    const text = await file.text();
                    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                    if (lines.length <= 1) {
                        feedback.innerText = 'CSV appears empty or missing rows.';
                        feedback.style.display = 'block';
                        submitBtn.disabled = false;
                        return;
                    }

                    // Try to guess header and ID column
                    const header = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                    let idCol = header.findIndex(h => /id|identifier/i.test(h));
                    if (idCol === -1) idCol = 1; // fallback assume second column

                    const idNumbers = lines.slice(1).map(r => {
                        const cols = r.split(',');
                        return (cols[idCol] || '').trim();
                    }).filter(x => x);

                    // Post to server check endpoint
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    const res = await fetch('/Students/CheckIdsBulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                        body: JSON.stringify(idNumbers)
                    });
                    const data = await res.json();
                    if (data && data.existing && data.existing.length > 0) {
                        feedback.innerText = `Duplicate IDs found in system: ${data.existing.slice(0,5).join(', ')}${data.existing.length>5? '...' : ''}`;
                        feedback.style.display = 'block';
                        submitBtn.disabled = false;
                        return;
                    }

                    // no duplicates detected, submit form normally
                    form.submit();
                } catch (err) {
                    console.error(err);
                    feedback.innerText = 'Error validating CSV before upload.';
                    feedback.style.display = 'block';
                    submitBtn.disabled = false;
                }
            });
        })();
    </script>
}

    @* TempData alerts are displayed globally in the layout; local alerts removed to avoid duplication *@

    <div class="table-responsive bg-white text-black p-3 rounded shadow-sm">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>FullName</th>
                    <th>ID Number</th>
                    <th>Username (Login)</th>
                    <th>Department</th>
                    <th>Year</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td class="fw-bold">@item.FullName</td>
                        <td>@item.IdNumber</td>
                        <td><span>@item.User?.UserName</span></td>
                        <td>@item.Department</td>
                        <td>@item.AcademicYear</td>
                        <td>
                            <a asp-action="Edit" asp-route-id="@item.StudentId" class="btn btn-sm btn-outline-primary">Edit</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="mt-3 d-flex align-items-center gap-3">
            <a asp-action="Create" class="btn btn-primary">Add Student</a>

            <form id="bulkUploadForm" asp-action="BulkUpload" method="post" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                @Html.AntiForgeryToken()
                <input id="studentFileInput" type="file" name="studentFile" class="form-control form-control-sm" accept=".csv" required />
                <button id="bulkUploadSubmit" type="submit" class="btn btn-outline-primary btn-sm">Import</button>
                <div id="bulkUploadFeedback" class="form-text text-danger small ms-2" style="display:none;"></div>
            </form>

            <a class="btn btn-outline-secondary btn-sm" href="~/templates/student-upload-template.csv" download>
                <i class="bi bi-download me-1"></i>Student CSV template
            </a>
        </div>
    </div>
</div>